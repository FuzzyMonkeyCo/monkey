name: pr

on:
  pull_request: {}

jobs:
  tagfile:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0 # For $ git tag

    - name: Ensure Tagfile is usable
      run: grep -E '^[0-9]+[.][0-9]+[.][0-9]+$' Tagfile

    - name: Checkout master Tagfile
      uses: actions/checkout@v2
      with:
        ref: master
        path: ./master-Tagfile

    - name: Ensure Tagfile has changes
      run: '! diff -q Tagfile ./master-Tagfile/Tagfile'

    - name: Ensure tag wasn't published already
      run: git tag | grep -vF $(cat Tagfile)

  checks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        check:
        - goreleaser-dist
        - ci-check--lint
        - ci-check--mod
        - ci-check--test
        - ci-check--protolock
    steps:
    - name: Set lowercase image name
      run: echo IMAGE=ghcr.io/${SLUG,,} >>$GITHUB_ENV
      env:
        SLUG: ${{ github.repository }}

    - uses: actions/checkout@v2

    - uses: docker/setup-buildx-action@v1

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - uses: docker/bake-action@v1.7.0
      with:
        files: ./docker-bake.hcl
        targets: ${{ matrix.check }}
        set: |
          *.cache-to=type=registry,ref=${{ env.IMAGE }}:${{ matrix.check }},mode=max

    - if: github.ref == 'refs/heads/master'
      name: If on master push image to GHCR
      run: docker push ${{ env.IMAGE }}:${{ matrix.check }}

    - if: matrix.check == 'goreleaser-dist'
      name: Test CLI
      run: |
        tar zxvf ./dist/monkey-Linux-x86_64.tar.gz -C .
        ./monkey -h | grep monkey
        ./monkey help | grep monkey
        ./monkey version
        ./monkey fmt
        [[ $(./monkey version | wc -l) = 1 ]]
        ./monkey version | grep -F $(cat Tagfile)
        ./monkey --version | grep -F $(cat Tagfile)
